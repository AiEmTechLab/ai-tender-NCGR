import re, json
import fitz  # ููุชุจุฉ PyMuPDF ููุฑุงุกุฉ ุนุฏุฏ ุตูุญุงุช PDF

# ============================================================
# ๐ฆ ุงุณุชุฎุฑุงุฌ JSON ูู ุงููุต ุญุชู ูู ูุงู ูุญุงุทูุง ุจููุงู ุฅุถุงูู
# ============================================================
def robust_json_extract(text):
    """ูุญุงูู ุงุณุชุฎุฑุงุฌ JSON ุตุงูุญ ูู ุงููุต ุญุชู ูู ูุงู ูุญุงุทูุง ุจูุตูุต ุฃุฎุฑู."""
    match = re.search(r"(\[.*\]|\{.*\})", text, flags=re.S)
    if match:
        try:
            return json.loads(match.group(1))
        except:
            try:
                return json.loads(match.group(1).replace("'", '"'))
            except:
                return None
    return None


# ============================================================
# ๐งฎ ุชุญููู ุงููุชูุณุท (1..4) ุฅูู ูุณุจุฉ ูุนูุงุฑูุฉ (0..1)
# ============================================================
def normalized_mean_score(df_scores):
    """ุชุญููู ูุชูุณุท ุงูุฏุฑุฌุงุช ูู ุงููุฏู (1..4) ุฅูู (0..1)."""
    if df_scores.empty:
        return 0.0
    m = df_scores["score"].astype(float).mean()
    return float((m - 1) / 3.0)


# ============================================================
# ๐ ุญุณุงุจ ุนุฏุฏ ุตูุญุงุช ููู PDF (ููุชุญูู ูู ุงููุฑุงุกุฉ ุงููุงููุฉ)
# ============================================================
def pdf_page_count(file_like):
    """
    ููุฑุฌุน ุนุฏุฏ ุตูุญุงุช ููู PDF ูู ุงููุงุฆู ุงููุฑููุน (UploadedFile).
    ููุณุชุฎุฏู ููุชุญูู ูู ูุฏู ูุฑุงุกุฉ ุงููุณุชูุฏ ุจุงููุงูู.
    """
    try:
        # ููุชุญ ุงูููู ูู ุงูุฐุงูุฑุฉ
        with fitz.open(stream=file_like.read(), filetype="pdf") as doc:
            total_pages = doc.page_count
        # ูุนูุฏ ุงููุคุดุฑ ูุจุฏุงูุฉ ุงูููู ุญุชู ูุง ูุคุซุฑ ุนูู ุนูููุงุช ุงููุฑุงุกุฉ ุงูุชุงููุฉ
        file_like.seek(0)
        return total_pages
    except Exception as e:
        try:
            file_like.seek(0)
        except:
            pass
        print(f"โ๏ธ ุฎุทุฃ ุฃุซูุงุก ุญุณุงุจ ุตูุญุงุช PDF: {e}")
        return None
